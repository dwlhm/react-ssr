{"version":3,"file":"sharedClone.js","sources":["../../src/sharedClone.ts"],"sourcesContent":["/**\n * This function returns `a` if `b` is deeply equal.\n * If not, it will replace any deeply equal children of `b` with those of `a`.\n * This can be used for structural sharing between JSON values for example.\n */\nexport function sharedClone<T>(prev: any, next: T, touchAll?: boolean): T {\n  const things = new Map()\n\n  function recurse(prev: any, next: any) {\n    if (prev === next) {\n      return prev\n    }\n\n    if (things.has(next)) {\n      return things.get(next)\n    }\n\n    const prevIsArray = Array.isArray(prev)\n    const nextIsArray = Array.isArray(next)\n    const prevIsObj = isPlainObject(prev)\n    const nextIsObj = isPlainObject(next)\n\n    const isArray = prevIsArray && nextIsArray\n    const isObj = prevIsObj && nextIsObj\n\n    const isSameStructure = isArray || isObj\n\n    // Both are arrays or objects\n    if (isSameStructure) {\n      const aSize = isArray ? prev.length : Object.keys(prev).length\n      const bItems = isArray ? next : Object.keys(next)\n      const bSize = bItems.length\n      const copy: any = isArray ? [] : {}\n\n      let equalItems = 0\n\n      for (let i = 0; i < bSize; i++) {\n        const key = isArray ? i : bItems[i]\n        if (copy[key] === prev[key]) {\n          equalItems++\n        }\n      }\n      if (aSize === bSize && equalItems === aSize) {\n        things.set(next, prev)\n        return prev\n      }\n      things.set(next, copy)\n      for (let i = 0; i < bSize; i++) {\n        const key = isArray ? i : bItems[i]\n        if (typeof bItems[i] === 'function') {\n          copy[key] = prev[key]\n        } else {\n          copy[key] = recurse(prev[key], next[key])\n        }\n        if (copy[key] === prev[key]) {\n          equalItems++\n        }\n      }\n\n      return copy\n    }\n\n    if (nextIsArray) {\n      const copy: any[] = []\n      things.set(next, copy)\n      for (let i = 0; i < next.length; i++) {\n        copy[i] = recurse(undefined, next[i])\n      }\n      return copy as T\n    }\n\n    if (nextIsObj) {\n      const copy = {} as any\n      things.set(next, copy)\n      const nextKeys = Object.keys(next)\n      for (let i = 0; i < nextKeys.length; i++) {\n        const key = nextKeys[i]!\n        copy[key] = recurse(undefined, next[key])\n      }\n      return copy as T\n    }\n\n    return next\n  }\n\n  return recurse(prev, next)\n}\n\n// Copied from: https://github.com/jonschlinkert/is-plain-object\nfunction isPlainObject(o: any) {\n  if (!hasObjectPrototype(o)) {\n    return false\n  }\n\n  // If has modified constructor\n  const ctor = o.constructor\n  if (typeof ctor === 'undefined') {\n    return true\n  }\n\n  // If has modified prototype\n  const prot = ctor.prototype\n  if (!hasObjectPrototype(prot)) {\n    return false\n  }\n\n  // If constructor does not have an Object-specific method\n  if (!prot.hasOwnProperty('isPrototypeOf')) {\n    return false\n  }\n\n  // Most likely a plain Object\n  return true\n}\n\nfunction hasObjectPrototype(o: any) {\n  return Object.prototype.toString.call(o) === '[object Object]'\n}\n"],"names":["sharedClone","prev","next","touchAll","things","Map","recurse","has","get","prevIsArray","Array","isArray","nextIsArray","prevIsObj","isPlainObject","nextIsObj","isObj","isSameStructure","aSize","length","Object","keys","bItems","bSize","copy","equalItems","i","key","set","undefined","nextKeys","o","hasObjectPrototype","ctor","constructor","prot","prototype","hasOwnProperty","toString","call"],"mappings":";;;;;;;;;;;;;;AAAA;AACA;AACA;AACA;AACA;AACO,SAASA,WAAW,CAAIC,IAAS,EAAEC,IAAO,EAAEC,QAAkB,EAAK;AACxE,EAAA,MAAMC,MAAM,GAAG,IAAIC,GAAG,EAAE,CAAA;AAExB,EAAA,SAASC,OAAO,CAACL,IAAS,EAAEC,IAAS,EAAE;IACrC,IAAID,IAAI,KAAKC,IAAI,EAAE;AACjB,MAAA,OAAOD,IAAI,CAAA;AACb,KAAA;AAEA,IAAA,IAAIG,MAAM,CAACG,GAAG,CAACL,IAAI,CAAC,EAAE;AACpB,MAAA,OAAOE,MAAM,CAACI,GAAG,CAACN,IAAI,CAAC,CAAA;AACzB,KAAA;AAEA,IAAA,MAAMO,WAAW,GAAGC,KAAK,CAACC,OAAO,CAACV,IAAI,CAAC,CAAA;AACvC,IAAA,MAAMW,WAAW,GAAGF,KAAK,CAACC,OAAO,CAACT,IAAI,CAAC,CAAA;AACvC,IAAA,MAAMW,SAAS,GAAGC,aAAa,CAACb,IAAI,CAAC,CAAA;AACrC,IAAA,MAAMc,SAAS,GAAGD,aAAa,CAACZ,IAAI,CAAC,CAAA;AAErC,IAAA,MAAMS,OAAO,GAAGF,WAAW,IAAIG,WAAW,CAAA;AAC1C,IAAA,MAAMI,KAAK,GAAGH,SAAS,IAAIE,SAAS,CAAA;AAEpC,IAAA,MAAME,eAAe,GAAGN,OAAO,IAAIK,KAAK,CAAA;;AAExC;AACA,IAAA,IAAIC,eAAe,EAAE;AACnB,MAAA,MAAMC,KAAK,GAAGP,OAAO,GAAGV,IAAI,CAACkB,MAAM,GAAGC,MAAM,CAACC,IAAI,CAACpB,IAAI,CAAC,CAACkB,MAAM,CAAA;MAC9D,MAAMG,MAAM,GAAGX,OAAO,GAAGT,IAAI,GAAGkB,MAAM,CAACC,IAAI,CAACnB,IAAI,CAAC,CAAA;AACjD,MAAA,MAAMqB,KAAK,GAAGD,MAAM,CAACH,MAAM,CAAA;AAC3B,MAAA,MAAMK,IAAS,GAAGb,OAAO,GAAG,EAAE,GAAG,EAAE,CAAA;MAEnC,IAAIc,UAAU,GAAG,CAAC,CAAA;MAElB,KAAK,IAAIC,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGH,KAAK,EAAEG,CAAC,EAAE,EAAE;QAC9B,MAAMC,GAAG,GAAGhB,OAAO,GAAGe,CAAC,GAAGJ,MAAM,CAACI,CAAC,CAAC,CAAA;QACnC,IAAIF,IAAI,CAACG,GAAG,CAAC,KAAK1B,IAAI,CAAC0B,GAAG,CAAC,EAAE;AAC3BF,UAAAA,UAAU,EAAE,CAAA;AACd,SAAA;AACF,OAAA;AACA,MAAA,IAAIP,KAAK,KAAKK,KAAK,IAAIE,UAAU,KAAKP,KAAK,EAAE;AAC3Cd,QAAAA,MAAM,CAACwB,GAAG,CAAC1B,IAAI,EAAED,IAAI,CAAC,CAAA;AACtB,QAAA,OAAOA,IAAI,CAAA;AACb,OAAA;AACAG,MAAAA,MAAM,CAACwB,GAAG,CAAC1B,IAAI,EAAEsB,IAAI,CAAC,CAAA;MACtB,KAAK,IAAIE,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGH,KAAK,EAAEG,CAAC,EAAE,EAAE;QAC9B,MAAMC,GAAG,GAAGhB,OAAO,GAAGe,CAAC,GAAGJ,MAAM,CAACI,CAAC,CAAC,CAAA;AACnC,QAAA,IAAI,OAAOJ,MAAM,CAACI,CAAC,CAAC,KAAK,UAAU,EAAE;AACnCF,UAAAA,IAAI,CAACG,GAAG,CAAC,GAAG1B,IAAI,CAAC0B,GAAG,CAAC,CAAA;AACvB,SAAC,MAAM;AACLH,UAAAA,IAAI,CAACG,GAAG,CAAC,GAAGrB,OAAO,CAACL,IAAI,CAAC0B,GAAG,CAAC,EAAEzB,IAAI,CAACyB,GAAG,CAAC,CAAC,CAAA;AAC3C,SAAA;QACA,IAAIH,IAAI,CAACG,GAAG,CAAC,KAAK1B,IAAI,CAAC0B,GAAG,CAAC,EAAE;AAC3BF,UAAAA,UAAU,EAAE,CAAA;AACd,SAAA;AACF,OAAA;AAEA,MAAA,OAAOD,IAAI,CAAA;AACb,KAAA;AAEA,IAAA,IAAIZ,WAAW,EAAE;MACf,MAAMY,IAAW,GAAG,EAAE,CAAA;AACtBpB,MAAAA,MAAM,CAACwB,GAAG,CAAC1B,IAAI,EAAEsB,IAAI,CAAC,CAAA;AACtB,MAAA,KAAK,IAAIE,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGxB,IAAI,CAACiB,MAAM,EAAEO,CAAC,EAAE,EAAE;AACpCF,QAAAA,IAAI,CAACE,CAAC,CAAC,GAAGpB,OAAO,CAACuB,SAAS,EAAE3B,IAAI,CAACwB,CAAC,CAAC,CAAC,CAAA;AACvC,OAAA;AACA,MAAA,OAAOF,IAAI,CAAA;AACb,KAAA;AAEA,IAAA,IAAIT,SAAS,EAAE;MACb,MAAMS,IAAI,GAAG,EAAS,CAAA;AACtBpB,MAAAA,MAAM,CAACwB,GAAG,CAAC1B,IAAI,EAAEsB,IAAI,CAAC,CAAA;AACtB,MAAA,MAAMM,QAAQ,GAAGV,MAAM,CAACC,IAAI,CAACnB,IAAI,CAAC,CAAA;AAClC,MAAA,KAAK,IAAIwB,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGI,QAAQ,CAACX,MAAM,EAAEO,CAAC,EAAE,EAAE;AACxC,QAAA,MAAMC,GAAG,GAAGG,QAAQ,CAACJ,CAAC,CAAE,CAAA;AACxBF,QAAAA,IAAI,CAACG,GAAG,CAAC,GAAGrB,OAAO,CAACuB,SAAS,EAAE3B,IAAI,CAACyB,GAAG,CAAC,CAAC,CAAA;AAC3C,OAAA;AACA,MAAA,OAAOH,IAAI,CAAA;AACb,KAAA;AAEA,IAAA,OAAOtB,IAAI,CAAA;AACb,GAAA;AAEA,EAAA,OAAOI,OAAO,CAACL,IAAI,EAAEC,IAAI,CAAC,CAAA;AAC5B,CAAA;;AAEA;AACA,SAASY,aAAa,CAACiB,CAAM,EAAE;AAC7B,EAAA,IAAI,CAACC,kBAAkB,CAACD,CAAC,CAAC,EAAE;AAC1B,IAAA,OAAO,KAAK,CAAA;AACd,GAAA;;AAEA;AACA,EAAA,MAAME,IAAI,GAAGF,CAAC,CAACG,WAAW,CAAA;AAC1B,EAAA,IAAI,OAAOD,IAAI,KAAK,WAAW,EAAE;AAC/B,IAAA,OAAO,IAAI,CAAA;AACb,GAAA;;AAEA;AACA,EAAA,MAAME,IAAI,GAAGF,IAAI,CAACG,SAAS,CAAA;AAC3B,EAAA,IAAI,CAACJ,kBAAkB,CAACG,IAAI,CAAC,EAAE;AAC7B,IAAA,OAAO,KAAK,CAAA;AACd,GAAA;;AAEA;AACA,EAAA,IAAI,CAACA,IAAI,CAACE,cAAc,CAAC,eAAe,CAAC,EAAE;AACzC,IAAA,OAAO,KAAK,CAAA;AACd,GAAA;;AAEA;AACA,EAAA,OAAO,IAAI,CAAA;AACb,CAAA;AAEA,SAASL,kBAAkB,CAACD,CAAM,EAAE;EAClC,OAAOX,MAAM,CAACgB,SAAS,CAACE,QAAQ,CAACC,IAAI,CAACR,CAAC,CAAC,KAAK,iBAAiB,CAAA;AAChE;;;;"}